<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Previous head content remains the same -->
    <!-- ... -->
</head>
<body>
    <!-- Previous HTML content remains the same -->
    <!-- ... -->

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9O1-QzrMD8c6bkifwMlzneLTU8eB4PH8",
            authDomain: "login-coc.firebaseapp.com",
            projectId: "login-coc",
            storageBucket: "login-coc.appspot.com",
            messagingSenderId: "793350174008",
            appId: "1:793350174008:web:47f655787f71f4e852bdcd",
            measurementId: "G-9F5XW0QKCV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements - previous declarations remain the same
            // ...

            // App state
            const MAX_TESTS = 500;
            let appState = {
                currentUser: null,
                quizState: {
                    questions: [],
                    userAnswers: {},
                    score: 0,
                    timeLeft: 60,
                    timerInterval: null,
                    startTime: null,
                    endTime: null
                }
            };
            
            // Initialize the app
            function init() {
                loadState();
                setupEventListeners();
                
                // Set up auth state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        try {
                            const userId = user.uid;
                            const userDocRef = doc(db, "users", userId);
                            const userDocSnap = await getDoc(userDocRef);
                            
                            let userData;
                            if (userDocSnap.exists()) {
                                userData = userDocSnap.data();
                            } else {
                                // Create new user document
                                userData = {
                                    displayName: user.displayName,
                                    email: user.email,
                                    photoURL: user.photoURL,
                                    history: [],
                                    createdAt: new Date().toISOString()
                                };
                                await setDoc(userDocRef, userData);
                            }
                            
                            appState.currentUser = {
                                uid: userId,
                                ...userData
                            };
                            
                            saveState();
                            welcomeUserEl.textContent = `Welcome, ${user.displayName || 'User'}!`;
                            showStartScreen();
                        } catch (error) {
                            console.error("Error loading user data:", error);
                            signOut(auth);
                        }
                    } else {
                        appState.currentUser = null;
                        saveState();
                        showLoginScreen();
                    }
                });
                
                // Set initial theme
                if (localStorage.getItem('darkMode') === 'true') {
                    document.body.classList.add('dark-mode');
                    darkModeToggle.checked = true;
                    themeLabel.textContent = 'Light';
                }
            }

            // Start the quiz timer - Fixed implementation
            function startTimer() {
                // Clear any existing timer
                if (appState.quizState.timerInterval) {
                    clearInterval(appState.quizState.timerInterval);
                }
                
                appState.quizState.startTime = new Date();
                appState.quizState.timeLeft = 60;
                popupTimer.classList.remove('visible');
                timerEl.classList.remove('warning');
                
                updateTimerDisplay();
                
                appState.quizState.timerInterval = setInterval(() => {
                    appState.quizState.timeLeft--;
                    updateTimerDisplay();
                    
                    if (appState.quizState.timeLeft <= 10) {
                        timerEl.classList.add('warning');
                        
                        if (appState.quizState.timeLeft <= 5) {
                            popupTimer.textContent = `Hurry! ${appState.quizState.timeLeft} seconds left!`;
                            popupTimer.classList.add('visible');
                            popupTimer.style.animationDuration = `${0.2 + (appState.quizState.timeLeft * 0.1)}s`;
                        }
                    }
                    
                    if (appState.quizState.timeLeft <= 0) {
                        clearInterval(appState.quizState.timerInterval);
                        popupTimer.textContent = "Time's up! Submitting your quiz...";
                        setTimeout(() => {
                            popupTimer.classList.remove('visible');
                            submitQuiz(true);
                        }, 1000);
                    }
                }, 1000);
            }

            // Submit quiz - Fixed implementation
            async function submitQuiz(isTimeUp = false) {
                try {
                    popupTimer.classList.remove('visible');
                    
                    if (appState.quizState.timerInterval) {
                        clearInterval(appState.quizState.timerInterval);
                        appState.quizState.timerInterval = null;
                    }
                    
                    appState.quizState.endTime = new Date();
                    
                    // Calculate score
                    appState.quizState.score = 0;
                    appState.quizState.questions.forEach((question, index) => {
                        if (appState.quizState.userAnswers[index] === question.answer) {
                            appState.quizState.score += 5;
                        }
                    });
                    
                    const timeTaken = Math.floor((appState.quizState.endTime - appState.quizState.startTime) / 1000);
                    
                    // Only proceed if user is authenticated
                    if (appState.currentUser && appState.currentUser.uid) {
                        const testResult = {
                            score: appState.quizState.score,
                            timeTaken: timeTaken,
                            date: new Date().toISOString(),
                            isTimeUp: isTimeUp
                        };
                        
                        const userId = appState.currentUser.uid;
                        const userDocRef = doc(db, "users", userId);
                        
                        // Get current history
                        const userDocSnap = await getDoc(userDocRef);
                        const currentHistory = userDocSnap.exists() ? userDocSnap.data().history || [] : [];
                        
                        // Update history
                        const updatedHistory = [...currentHistory, testResult];
                        
                        // Update user document
                        await setDoc(userDocRef, {
                            history: updatedHistory,
                            lastActive: new Date().toISOString()
                        }, { merge: true });
                        
                        // Update local state
                        appState.currentUser.history = updatedHistory;
                    }
                    
                    saveState();
                    showResults(isTimeUp, timeTaken);
                } catch (error) {
                    console.error("Error submitting quiz:", error);
                    alert("An error occurred while submitting your quiz. Please try again.");
                    showStartScreen();
                }
            }

            // Rest of the functions remain largely the same
            // ...
            
            // Initialize the app
            init();
        });
    </script>
</body>
</html>
